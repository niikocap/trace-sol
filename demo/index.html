<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rice Supply Chain dApp</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Poppins', 'sans-serif'],
                    },
                    colors: {
                        primary: {
                            DEFAULT: '#008540',
                            hover: '#006b34',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        
        :root {
            --primary-color: #008540;
            --primary-hover: #006b34;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.05), 0 1px 2px rgba(0, 0, 0, 0.1);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.05), 0 10px 10px -5px rgba(0, 0, 0, 0.02);
        }
        
        * {
            font-family: 'Poppins', sans-serif;
        }
        
        body {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        .chip-button {
            padding: 0.25rem 0.75rem;
            font-size: 0.875rem;
            background-color: var(--primary-color);
            color: white;
            border-radius: 9999px;
            border: 1px solid var(--primary-color);
            transition: all 0.2s;
            cursor: pointer;
        }
        .chip-button:hover {
            background-color: var(--primary-hover);
            color: white;
            border-color: var(--primary-hover);
        }
        .chip-button.selected {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: white;
            border-radius: 8px;
            padding: 24px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }
        .shadow-sm {
            box-shadow: var(--shadow-sm);
        }
        
        .shadow-md {
            box-shadow: var(--shadow);
        }
        
        .shadow-lg {
            box-shadow: var(--shadow-md);
        }
        
        .shadow-xl {
            box-shadow: var(--shadow-lg);
        }
        .tab-button.border-green-500, .tab-button:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <header class="bg-white shadow-md rounded-lg p-6 mb-4">
            <div class="flex justify-between items-center">
                <h1 class="text-3xl font-bold text-green-600">🌾 DigiSaka TRACE dApp</h1>
                <div id="wallet-section">
                    <button id="connect-wallet" class="bg-primary hover:bg-primary-hover text-white font-bold py-2 px-4 rounded transition-colors">
                        Connect Wallet
                    </button>
                    <div id="wallet-info" class="hidden">
                        <span class="text-sm text-gray-600">Connected: </span>
                        <span id="wallet-address" class="text-sm font-mono"></span>
                        <button id="disconnect-wallet" class="ml-2 bg-red-500 hover:bg-red-600 text-white text-xs py-1 px-2 rounded transition-colors">
                            Disconnect
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <div class="bg-white shadow-md rounded-lg mb-4">
            <nav class="flex space-x-8 px-6">
                <button class="tab-button py-4 px-2 border-b-2 border-primary text-primary font-medium transition-colors duration-200" data-tab="chain-actors">Chain Actors</button>
                <button class="tab-button py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-primary font-medium transition-colors duration-200" data-tab="production-seasons">Production Seasons</button>
                <button class="tab-button py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-primary font-medium transition-colors duration-200" data-tab="milling">Milling</button>
                <button class="tab-button py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-primary font-medium transition-colors duration-200" data-tab="rice-batches">Rice Batches</button>
                <button class="tab-button py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-primary font-medium transition-colors duration-200" data-tab="transactions">Transactions</button>
                <button class="tab-button py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-primary font-medium transition-colors duration-200" data-tab="batch-tracker">Batch Tracker</button>
                <button class="tab-button py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-primary font-medium transition-colors duration-200" data-tab="api-docs">API Docs</button>
            </nav>
        </div>
        <!-- System Status -->
        <div class="mb-4 p-4 bg-white rounded-lg">
            <div class="flex space-x-8">
                <div class="flex items-center space-x-2">
                    <div id="solana-status" class="w-3 h-3 bg-gray-400 rounded-full"></div>
                    <span class="text-sm">Solana: <span id="solana-status-text">Checking...</span></span>
                </div>
                <div class="flex items-center space-x-2">
                    <div id="api-status" class="w-3 h-3 bg-gray-400 rounded-full"></div>
                    <span class="text-sm">API: <span id="api-status-text">Checking...</span></span>
                </div>
            </div>
        </div>
        <!-- Chain Actors Tab -->
        <div id="chain-actors-tab" class="tab-content">
            <div class="bg-white shadow-md rounded-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-800">Chain Actors</h2>
                    <div class="flex items-center space-x-4">
                        <label class="flex items-center">
                            <input type="checkbox" id="show-all-actors" class="mr-2">
                            <span class="text-sm text-gray-600">Show deleted</span>
                        </label>
                        <button id="add-actor-btn" class="bg-primary hover:bg-primary-hover text-white font-bold py-2 px-4 rounded transition-colors">
                            Add Actor
                        </button>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="min-w-full table-auto">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Organization</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Public Key</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="actors-table" class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td colspan="6" class="px-4 py-4 text-center text-gray-500">No actors found</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <button id="refresh-actors" class="mt-4 bg-primary hover:bg-primary-hover text-white font-bold py-2 px-4 rounded transition-colors">
                    Refresh Actors
                </button>
            </div>
        </div>

        <!-- Production Seasons Tab -->
        <div id="production-seasons-tab" class="tab-content hidden">
            <div class="bg-white shadow-md rounded-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-800">Production Seasons</h2>
                    <div class="flex items-center space-x-4">
                        <label class="flex items-center">
                            <input type="checkbox" id="show-all-seasons" class="mr-2">
                            <span class="text-sm text-gray-600">Show deleted</span>
                        </label>
                        <button id="add-season-btn" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">
                            Add Season
                        </button>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="min-w-full table-auto">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Season</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Farmer</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Variety</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Yield</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Carbon Certified</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="seasons-table" class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td colspan="6" class="px-4 py-4 text-center text-gray-500">No seasons found</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <button id="refresh-seasons" class="mt-4 bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                    Refresh Seasons
                </button>
            </div>
        </div>

        <!-- Milling Tab -->
        <div id="milling-tab" class="tab-content hidden">
            <div class="bg-white shadow-md rounded-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-800">Milled Rice</h2>
                    <div class="flex items-center space-x-4">
                        <label class="flex items-center">
                            <input type="checkbox" id="show-all-milled" class="mr-2">
                            <span class="text-sm text-gray-600">Show deleted</span>
                        </label>
                        <button id="add-milling-btn" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">
                            Add Milled Rice
                        </button>
                    </div>
                </div>
            
                <div class="overflow-x-auto">
                    <table class="min-w-full table-auto">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Machine</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Batch</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Grade</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Quantity</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Moisture</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="milling-table" class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td colspan="6" class="px-4 py-4 text-center text-gray-500">No milled rice found</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <button id="refresh-milling" class="mt-4 bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                    Refresh Milled Rice
                </button>
            </div>
        </div>

        <!-- Rice Batches Tab -->
        <div id="rice-batches-tab" class="tab-content hidden">
            <div class="bg-white shadow-md rounded-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-800">Rice Batches</h2>
                    <div class="flex items-center space-x-4">
                        <label class="flex items-center">
                            <input type="checkbox" id="show-all-batches" class="mr-2">
                            <span class="text-sm text-gray-600">Show deleted</span>
                        </label>
                        <button id="add-batch-btn" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">
                            Add Batch
                        </button>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="min-w-full table-auto">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Batch ID</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Quantity</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Season</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Validation</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="batches-table" class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td colspan="6" class="px-4 py-4 text-center text-gray-500">No batches found</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <button id="refresh-batches" class="mt-4 bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                    Refresh Batches
                </button>
            </div>
        </div>

        <!-- Transactions Tab -->
        <div id="transactions-tab" class="tab-content hidden">
            <div class="bg-white shadow-md rounded-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-800">Chain Transactions</h2>
                    <div class="flex items-center space-x-4">
                        <label class="flex items-center">
                            <input type="checkbox" id="show-all-transactions" class="mr-2">
                            <span class="text-sm text-gray-600">Show deleted</span>
                        </label>
                        <button id="add-transaction-btn" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">
                            Add Transaction
                        </button>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="min-w-full table-auto">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Batch</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">From</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">To</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Amount</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="transactions-table" class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td colspan="6" class="px-4 py-4 text-center text-gray-500">No transactions found</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <button id="refresh-transactions" class="mt-4 bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                    Refresh Transactions
                </button>
            </div>
        </div>

        <!-- Batch Tracker Tab -->
        <div id="batch-tracker-tab" class="tab-content hidden">
            <div class="bg-white shadow-md rounded-lg p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-6">Batch Tracker</h2>
                
                <!-- Batch Selection -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Select Batch:</label>
                    <select id="batch-selector" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Select a batch...</option>
                    </select>
                </div>

                <!-- Batch Details -->
                <div id="batch-details" class="hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Batch Information -->
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold text-gray-800 mb-3">Batch Information</h3>
                            <div class="space-y-2">
                                <div><span class="font-medium">QR Code:</span> <span id="batch-qr-code"></span></div>
                                <div><span class="font-medium">Weight:</span> <span id="batch-weight"></span> kg</div>
                                <div><span class="font-medium">Moisture Content:</span> <span id="batch-moisture"></span>%</div>
                                <div><span class="font-medium">Price per kg:</span> $<span id="batch-price"></span></div>
                                <div><span class="font-medium">Status:</span> <span id="batch-status-display" class="px-2 py-1 rounded text-sm"></span></div>
                                <div><span class="font-medium">Blockchain Tx:</span> <span id="batch-blockchain-tx" class="font-mono text-xs break-all"></span></div>
                            </div>
                        </div>

                        <!-- Production Season Details -->
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold text-gray-800 mb-3">Production Season</h3>
                            <div id="season-details" class="space-y-2">
                                <div><span class="font-medium">Crop Year:</span> <span id="season-crop-year"></span></div>
                                <div><span class="font-medium">Rice Variety:</span> <span id="season-variety"></span></div>
                                <div><span class="font-medium">Planting Date:</span> <span id="season-planting-date"></span></div>
                                <div><span class="font-medium">Harvest Date:</span> <span id="season-harvest-date"></span></div>
                                <div><span class="font-medium">Total Yield:</span> <span id="season-total-yield"></span> kg</div>
                                <div><span class="font-medium">Carbon Certified:</span> <span id="season-carbon-certified"></span></div>
                            </div>
                        </div>

                        <!-- Milling Information -->
                        <div class="bg-green-50 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold text-gray-800 mb-3">Milling Information</h3>
                            <div id="milling-details" class="space-y-2">
                                <div><span class="font-medium">Milling Type:</span> <span id="milling-type"></span></div>
                                <div><span class="font-medium">Quality:</span> <span id="milling-quality"></span></div>
                                <div><span class="font-medium">Total Weight:</span> <span id="milling-total-weight"></span> kg</div>
                                <div><span class="font-medium">Processed Weight:</span> <span id="milling-processed-weight"></span> kg</div>
                                <div><span class="font-medium">Moisture:</span> <span id="milling-moisture"></span>%</div>
                            </div>
                        </div>

                        <!-- Chain Actor Information -->
                        <div class="bg-yellow-50 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold text-gray-800 mb-3">Current Holder</h3>
                            <div id="actor-details" class="space-y-2">
                                <div><span class="font-medium">Name:</span> <span id="actor-name"></span></div>
                                <div><span class="font-medium">Type:</span> <span id="actor-type"></span></div>
                                <div><span class="font-medium">Organization:</span> <span id="actor-organization"></span></div>
                                <div><span class="font-medium">Assigned TPS:</span> <span id="actor-tps"></span></div>
                            </div>
                        </div>
                    </div>

                    <!-- Transaction History -->
                    <div class="mt-6 bg-purple-50 p-4 rounded-lg">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">Transaction History</h3>
                        <div id="transaction-history" class="space-y-2">
                            <!-- Transaction entries will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- API Documentation Tab -->
        <div id="api-docs-tab" class="tab-content hidden">
            <div class="bg-white shadow-md rounded-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-800">API Documentation</h2>
                    <a href="swagger.html" target="_blank" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                        Open Full Swagger UI
                    </a>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- API Overview -->
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">API Overview</h3>
                        <div class="space-y-2 text-sm">
                            <div><span class="font-medium">Base URL:</span> <code class="bg-gray-200 px-2 py-1 rounded">http://localhost:3001/api</code></div>
                            <div><span class="font-medium">Version:</span> 1.0.0</div>
                    </div>
                    <p class="text-gray-600 mt-2">
                        All API endpoints are prefixed with the base URL above. The API requires authentication via API key.
                                    <td class="border border-gray-300 px-4 py-2"><code>/rice-batches/qr/{qrCode}</code></td>
                                    <td class="border border-gray-300 px-4 py-2">Get batch by QR code</td>
                                </tr>
                                <tr>
                                    <td class="border border-gray-300 px-4 py-2"><span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs">GET</span></td>
                                    <td class="border border-gray-300 px-4 py-2"><code>/chain-transactions</code></td>
                                    <td class="border border-gray-300 px-4 py-2">Get all chain transactions</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <p class="text-sm text-gray-600 mt-4">
                        <strong>Note:</strong> All endpoints support full CRUD operations (GET, POST, PUT, DELETE). 
                        Click "Open Full Swagger UI" above for complete interactive documentation with request/response examples.
                    </p>
                </div>
            </div>
        </div>
        
    </div>

    <!-- Modals -->
    <!-- Chain Actor Modal -->
    <div id="actor-modal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">Add Chain Actor</h2>
                <button class="close-modal text-gray-500 hover:text-primary text-2xl transition-colors duration-200">&times;</button>
            </div>
            <form id="actor-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Name</label>
                    <input type="text" id="actor-form-name" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Actor Type (Select multiple)</label>
                    <div id="actor-type-chips" class="mt-2 flex flex-wrap gap-2">
                        <button type="button" class="chip-button" data-value="Farmer">Farmer</button>
                        <button type="button" class="chip-button" data-value="Miller">Miller</button>
                        <button type="button" class="chip-button" data-value="Distributor">Distributor</button>
                        <button type="button" class="chip-button" data-value="Retailer">Retailer</button>
                    </div>
                    <input type="hidden" id="actor-form-type" value="">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Organization</label>
                    <select id="actor-form-organization" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2" required>
                        <option value="">Select Organization</option>
                        <option value="blo">BLO (Barangay Level Organization)</option>
                        <option value="buyback">Buyback Program</option>
                        <option value="coop">Cooperative</option>
                        <option value="none">None</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">PIN</label>
                    <input type="text" id="actor-form-pin" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Assigned TPS</label>
                    <input type="number" id="actor-form-tps" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2" required>
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" class="close-modal bg-gray-100 hover:bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded transition-colors duration-200">Cancel</button>
                    <button type="submit" class="bg-primary hover:bg-primary-hover text-white font-bold py-2 px-4 rounded transition-colors duration-200">Create Actor</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Production Season Modal -->
    <div id="season-modal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">Add Production Season</h2>
                <button class="close-modal text-gray-500 hover:text-primary text-2xl transition-colors duration-200">&times;</button>
            </div>
            <form id="season-form" class="space-y-4">
                <!-- Basic Information Row -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Farmer</label>
                        <select id="season-farmer" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2" required>
                            <option value="">Select Farmer</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Season Name</label>
                        <input type="text" id="season-name" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2" required>
                    </div>
                </div>
                
                <!-- Rice Details Row -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Rice Variety</label>
                        <select id="season-variety" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2" required>
                            <option value="">Select Variety</option>
                            <option value="Jasmine">Jasmine</option>
                            <option value="Basmati">Basmati</option>
                            <option value="Arborio">Arborio</option>
                            <option value="Brown Rice">Brown Rice</option>
                            <option value="Wild Rice">Wild Rice</option>
                            <option value="Red Rice">Red Rice</option>
                            <option value="Black Rice">Black Rice</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Moisture Content (%)</label>
                        <input type="number" step="0.1" id="season-moisture" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2" placeholder="14.0" required>
                    </div>
                </div>
                
                <!-- Dates Row -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Planting Date</label>
                        <input type="date" id="season-planting" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Harvest Date</label>
                        <input type="date" id="season-harvest" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2" required>
                    </div>
                </div>
                
                <!-- Yield and Irrigation Row -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Expected Yield (kg)</label>
                        <input type="number" id="season-yield" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Irrigation Practice</label>
                        <select id="season-irrigation" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2" required>
                            <option value="">Select Practice</option>
                            <option value="Flood Irrigation">Flood Irrigation</option>
                            <option value="Drip Irrigation">Drip Irrigation</option>
                            <option value="Sprinkler Irrigation">Sprinkler Irrigation</option>
                            <option value="Alternate Wetting and Drying">Alternate Wetting and Drying</option>
                            <option value="Rain-fed">Rain-fed</option>
                        </select>
                    </div>
                </div>
                <!-- Fertilizers and Pesticides Row -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Fertilizers Used</label>
                        <div id="fertilizer-chips" class="mt-2 flex flex-wrap gap-2">
                            <button type="button" class="chip-button" data-value="Organic Compost">Organic Compost</button>
                            <button type="button" class="chip-button" data-value="NPK 14-14-14">NPK 14-14-14</button>
                            <button type="button" class="chip-button" data-value="Urea">Urea</button>
                            <button type="button" class="chip-button" data-value="Phosphate">Phosphate</button>
                            <button type="button" class="chip-button" data-value="Potash">Potash</button>
                        </div>
                        <input type="hidden" id="season-fertilizers" value="">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Pesticides Used</label>
                        <div id="pesticide-chips" class="mt-2 flex flex-wrap gap-2">
                            <button type="button" class="chip-button" data-value="Neem Oil">Neem Oil</button>
                            <button type="button" class="chip-button" data-value="Bt Spray">Bt Spray</button>
                            <button type="button" class="chip-button" data-value="Copper Sulfate">Copper Sulfate</button>
                            <button type="button" class="chip-button" data-value="Pyrethrin">Pyrethrin</button>
                            <button type="button" class="chip-button" data-value="None">None</button>
                        </div>
                        <input type="hidden" id="season-pesticides" value="">
                    </div>
                </div>
                
                <!-- Carbon Certification -->
                <div class="flex items-center">
                    <input type="checkbox" id="season-carbon-certified" class="h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300 rounded">
                    <label for="season-carbon-certified" class="ml-2 block text-sm text-gray-700">Carbon Smart Certified</label>
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" class="close-modal bg-gray-100 hover:bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded transition-colors duration-200">Cancel</button>
                    <button type="submit" class="bg-primary hover:bg-primary-hover text-white font-bold py-2 px-4 rounded transition-colors duration-200">Create Season</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Milling Modal -->
    <div id="milling-modal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">Add Milled Rice</h2>
                <button class="close-modal text-gray-500 hover:text-primary text-2xl transition-colors duration-200">&times;</button>
            </div>
            <form id="milling-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Season</label>
                    <select id="milling-season-id" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2" required>
                        <option value="">Select Season</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Machine Name</label>
                    <input type="text" id="milling-machine-name" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Total Weight Processed (kg)</label>
                    <input type="number" id="milling-weight" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Moisture Content (%)</label>
                    <input type="number" step="0.1" id="milling-moisture" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2" placeholder="14.0" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Photo URLs (one per line)</label>
                    <textarea id="milling-photos" rows="3" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2" placeholder="Enter photo URLs, one per line"></textarea>
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" class="close-modal bg-gray-100 hover:bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded transition-colors duration-200">Cancel</button>
                    <button type="submit" class="bg-primary hover:bg-primary-hover text-white font-bold py-2 px-4 rounded transition-colors duration-200">Create Milled Rice</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Batch Modal -->
    <div id="batch-modal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">Add Rice Batch</h2>
                <button class="close-modal text-gray-500 hover:text-primary text-2xl transition-colors duration-200">&times;</button>
            </div>
            <form id="batch-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Quantity (kg)</label>
                    <input type="number" id="batch-quantity" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Season</label>
                    <select id="batch-season-id" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2" required>
                        <option value="">Select Season</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Validation Actor</label>
                    <select id="batch-validation-id" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2" required>
                        <option value="">Select Validator</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Drying Actor</label>
                    <select id="batch-drying-id" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2" required>
                        <option value="">Select Dryer</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Status</label>
                    <select id="batch-status" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2" required>
                        <option value="">Select Status</option>
                        <option value="forSale">For Sale</option>
                        <option value="stock">Stock</option>
                    </select>
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" class="close-modal bg-gray-100 hover:bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded transition-colors duration-200">Cancel</button>
                    <button type="submit" class="bg-primary hover:bg-primary-hover text-white font-bold py-2 px-4 rounded transition-colors duration-200">Create Batch</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Transaction Modal -->
    <div id="transaction-modal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">Add Transaction</h2>
                <button class="close-modal text-gray-500 hover:text-primary text-2xl transition-colors duration-200">&times;</button>
            </div>
            <form id="transaction-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Batch</label>
                    <select id="transaction-batch" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2" required>
                        <option value="">Select Batch</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">From Actor</label>
                    <select id="transaction-from" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2" required>
                        <option value="">Select From Actor</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">To Actor</label>
                    <select id="transaction-to" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2" required>
                        <option value="">Select To Actor</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Amount</label>
                    <input type="number" step="0.01" id="transaction-amount" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Payment Method</label>
                    <select id="transaction-payment" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2" required>
                        <option value="">Select Method</option>
                        <option value="cash">Cash</option>
                        <option value="cheque">Cheque</option>
                        <option value="online">Online</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Status</label>
                    <select id="transaction-status" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2" required>
                        <option value="">Select Status</option>
                        <option value="completed">Completed</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" class="close-modal bg-gray-100 hover:bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded transition-colors duration-200">Cancel</button>
                    <button type="submit" class="bg-primary hover:bg-primary-hover text-white font-bold py-2 px-4 rounded transition-colors duration-200">Create Transaction</button>
                </div>
            </form>
        </div>
    </div>
    

    <script>
        // Global state
        let wallet = null;
        let connection = null;
        const API_BASE = 'http://localhost:3001/api';
        
        // Auto-refresh status every 10 seconds
        setInterval(checkSystemStatus, 10000);

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            checkSystemStatus();
            loadActors();
            setupEventListeners();
        });

        function setupEventListeners() {
            document.getElementById('connect-wallet').addEventListener('click', connectWallet);
            document.getElementById('disconnect-wallet').addEventListener('click', disconnectWallet);
            
            // Tab switching
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', () => switchTab(button.dataset.tab));
            });
            
            // Modal buttons
            document.getElementById('add-actor-btn').addEventListener('click', () => openModal('actor-modal'));
            document.getElementById('add-season-btn').addEventListener('click', () => openModal('season-modal'));
            document.getElementById('add-milling-btn').addEventListener('click', () => openModal('milling-modal'));
            document.getElementById('add-batch-btn').addEventListener('click', () => openModal('batch-modal'));
            document.getElementById('add-transaction-btn').addEventListener('click', () => openModal('transaction-modal'));
            
            // Close modal buttons
            document.querySelectorAll('.close-modal').forEach(button => {
                button.addEventListener('click', closeModal);
            });
            
            // Close modal on backdrop click
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) closeModal();
                });
            });
            
            // Form submissions
            document.getElementById('actor-form').addEventListener('submit', createActor);
            document.getElementById('season-form').addEventListener('submit', createSeason);
            document.getElementById('milling-form').addEventListener('submit', createMilledRice);
            document.getElementById('batch-form').addEventListener('submit', createBatch);
            document.getElementById('transaction-form').addEventListener('submit', createTransaction);
            
            // Refresh buttons
            document.getElementById('refresh-actors').addEventListener('click', loadActors);
            document.getElementById('refresh-seasons').addEventListener('click', loadSeasons);
            document.getElementById('refresh-milling').addEventListener('click', loadMilledRice);
            document.getElementById('refresh-batches').addEventListener('click', loadBatches);
            document.getElementById('refresh-transactions').addEventListener('click', loadTransactions);
            
            // Show/hide inactive checkboxes
            document.getElementById('show-all-actors').addEventListener('change', () => {
                if (window.currentActorsData) displayActors(window.currentActorsData);
            });
            document.getElementById('show-all-seasons').addEventListener('change', () => {
                if (window.currentSeasonsData) displaySeasons(window.currentSeasonsData);
            });
            document.getElementById('show-all-milled').addEventListener('change', () => {
                if (window.currentMilledRiceData) displayMilledRice(window.currentMilledRiceData);
            });
            document.getElementById('show-all-batches').addEventListener('change', () => {
                if (window.currentBatchesData) displayBatches(window.currentBatchesData);
            });
            document.getElementById('show-all-transactions').addEventListener('change', () => {
                if (window.currentTransactionsData) displayTransactions(window.currentTransactionsData);
            });
            
            // Chip button functionality
            setupChipButtons();
            
            // Initialize batch tracker
            initializeBatchTracker();
        }

        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.add('show');
            
            // Populate dropdowns when opening modals
            if (modalId === 'season-modal') {
                populateFarmersDropdown();
            } else if (modalId === 'milling-modal') {
                populateBatchesDropdown('milling-batch');
            } else if (modalId === 'batch-modal') {
                populateSeasonsDropdown();
                populateActorsDropdown('batch-validation-id');
                populateActorsDropdown('batch-drying-id');
            } else if (modalId === 'transaction-modal') {
                populateBatchesDropdown('transaction-batch');
                populateActorsDropdown('transaction-from');
                populateActorsDropdown('transaction-to');
            }
        }

        function closeModal() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.classList.remove('show');
            });
            
            // Reset forms and edit states
            document.querySelectorAll('form').forEach(form => {
                form.reset();
                form.removeAttribute('data-edit-id');
                // Reset chip selections
                form.querySelectorAll('.chip-button.selected').forEach(chip => {
                    chip.classList.remove('selected');
                });
                form.querySelectorAll('input[type="hidden"]').forEach(hidden => {
                    hidden.value = '';
                });
            });
            
            // Reset modal titles to default
            document.querySelector('#actor-modal h2').textContent = 'Add Chain Actor';
            document.querySelector('#season-modal h2').textContent = 'Add Production Season';
            document.querySelector('#milling-modal h2').textContent = 'Add Milled Rice';
            document.querySelector('#batch-modal h2').textContent = 'Add Rice Batch';
            document.querySelector('#transaction-modal h2').textContent = 'Add Transaction';
        }

        async function populateFarmersDropdown() {
            try {
                const response = await fetch(`${API_BASE}/chain-actors`);
                const result = await response.json();
                const farmerSelect = document.getElementById('season-farmer');
                
                console.log('API response:', result);
                
                farmerSelect.innerHTML = '<option value="">Select Farmer</option>';
                
                // Handle the API response structure
                const actors = result.success ? (result.data.actors || []) : (result || []);
                console.log('All actors:', actors);
                
                const farmers = actors.filter(actor => {
                    console.log('Actor:', actor.name, 'Type:', actor.actorType);
                    return actor.actorType && Array.isArray(actor.actorType) && actor.actorType.includes('Farmer');
                });
                
                console.log('Filtered farmers:', farmers);
                
                farmers.forEach(farmer => {
                    const option = document.createElement('option');
                    option.value = farmer.publicKey;
                    option.textContent = farmer.name;
                    farmerSelect.appendChild(option);
                });
                
                if (farmers.length === 0) {
                    console.log('No farmers found. Check if actors have "Farmer" in their actorType array.');
                }
            } catch (error) {
                console.error('Error loading farmers:', error);
            }
        }

        async function populateActorsDropdown(selectId) {
            try {
                const response = await fetch(`${API_BASE}/chain-actors`);
                const result = await response.json();
                const select = document.getElementById(selectId);
                
                console.log('Actors API response for', selectId, ':', result);
                
                select.innerHTML = '<option value="">Select Actor</option>';
                
                // Handle the API response structure
                const actors = result.success ? (result.data.actors || []) : (result || []);
                
                actors.forEach(actor => {
                    const option = document.createElement('option');
                    option.value = actor.publicKey;
                    option.textContent = `${actor.name} (${Array.isArray(actor.actorType) ? actor.actorType.join(', ') : actor.actorType})`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading actors:', error);
            }
        }

        async function populateSeasonsDropdown() {
            try {
                const response = await fetch(`${API_BASE}/production-seasons`);
                const result = await response.json();
                const select = document.getElementById('batch-season-id');
                
                console.log('Seasons API response:', result);
                
                select.innerHTML = '<option value="">Select Season</option>';
                
                // Handle the API response structure
                const seasons = result.success ? (result.data.seasons || []) : (result || []);
                
                seasons.forEach(season => {
                    const option = document.createElement('option');
                    option.value = season.publicKey;
                    option.textContent = `${season.seasonName} - ${season.riceVariety}`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading seasons:', error);
            }
        }

        async function populateBatchesDropdown(selectId) {
            try {
                const response = await fetch(`${API_BASE}/rice-batches`);
                const result = await response.json();
                const select = document.getElementById(selectId);
                
                console.log('Batches API response for', selectId, ':', result);
                
                select.innerHTML = '<option value="">Select Batch</option>';
                
                // Handle the API response structure
                const batches = result.success ? (result.data.batches || []) : (result || []);
                
                batches.forEach(batch => {
                    const option = document.createElement('option');
                    option.value = batch.publicKey;
                    option.textContent = `${batch.qrCode} (${batch.batchWeightKg}kg)`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading batches:', error);
            }
        }

        function setupChipButtons() {
            // Fertilizer chips
            document.querySelectorAll('#fertilizer-chips .chip-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.preventDefault();
                    toggleChip(button, 'season-fertilizers');
                });
            });
            
            // Pesticide chips
            document.querySelectorAll('#pesticide-chips .chip-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.preventDefault();
                    toggleChip(button, 'season-pesticides');
                });
            });
            
            // Actor type chips
            document.querySelectorAll('#actor-type-chips .chip-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.preventDefault();
                    toggleChip(button, 'actor-form-type');
                });
            });
        }

        function toggleChip(button, hiddenInputId) {
            button.classList.toggle('selected');
            
            const hiddenInput = document.getElementById(hiddenInputId);
            const currentValues = hiddenInput.value ? hiddenInput.value.split(',') : [];
            const value = button.dataset.value;
            
            if (button.classList.contains('selected')) {
                if (!currentValues.includes(value)) {
                    currentValues.push(value);
                }
            } else {
                const index = currentValues.indexOf(value);
                if (index > -1) {
                    currentValues.splice(index, 1);
                }
            }
            
            hiddenInput.value = currentValues.join(',');
        }

        async function checkSystemStatus() {
            // Update status for all tabs
            const tabs = ['', 'seasons-', 'milling-', 'batches-', 'transactions-'];
            
            // Check API status
            try {
                const response = await fetch('http://localhost:3001/health', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                if (response.ok) {
                    tabs.forEach(prefix => {
                        const statusEl = document.getElementById(`${prefix}api-status`);
                        const textEl = document.getElementById(`${prefix}api-status-text`);
                        if (statusEl) statusEl.className = 'w-3 h-3 bg-green-500 rounded-full';
                        if (textEl) textEl.textContent = 'Connected';
                    });
                    addActivity('✅ API server connected');
                } else {
                    throw new Error(`API responded with status: ${response.status}`);
                }
            } catch (error) {
                tabs.forEach(prefix => {
                    const statusEl = document.getElementById(`${prefix}api-status`);
                    const textEl = document.getElementById(`${prefix}api-status-text`);
                    if (statusEl) statusEl.className = 'w-3 h-3 bg-red-500 rounded-full';
                    if (textEl) textEl.textContent = 'Disconnected';
                });
                addActivity('❌ API server disconnected: ' + error.message);
                console.error('API Connection Error:', error);
            }

            // Check Solana connection
            try {
                connection = new solanaWeb3.Connection('https://api.devnet.solana.com', 'confirmed');
                const version = await connection.getVersion();
                tabs.forEach(prefix => {
                    const statusEl = document.getElementById(`${prefix}solana-status`);
                    const textEl = document.getElementById(`${prefix}solana-status-text`);
                    if (statusEl) statusEl.className = 'w-3 h-3 bg-green-500 rounded-full';
                    if (textEl) textEl.textContent = 'Connected';
                });
                addActivity('✅ Solana validator connected');
            } catch (error) {
                tabs.forEach(prefix => {
                    const statusEl = document.getElementById(`${prefix}solana-status`);
                    const textEl = document.getElementById(`${prefix}solana-status-text`);
                    if (statusEl) statusEl.className = 'w-3 h-3 bg-red-500 rounded-full';
                    if (textEl) textEl.textContent = 'Disconnected';
                });
                addActivity('❌ Solana validator disconnected');
            }
        }

        async function connectWallet() {
            try {
                if (window.solana && window.solana.isPhantom) {
                    const response = await window.solana.connect();
                    wallet = response.publicKey.toString();
                    
                    document.getElementById('connect-wallet').classList.add('hidden');
                    document.getElementById('wallet-info').classList.remove('hidden');
                    document.getElementById('wallet-address').textContent = wallet.substring(0, 8) + '...';
                    
                    addActivity(`🔗 Wallet connected: ${wallet.substring(0, 16)}...`);
                } else {
                    alert('Phantom wallet not found! Please install Phantom wallet.');
                }
            } catch (error) {
                console.error('Wallet connection failed:', error);
                addActivity('❌ Wallet connection failed');
            }
        }

        function disconnectWallet() {
            wallet = null;
            document.getElementById('connect-wallet').classList.remove('hidden');
            document.getElementById('wallet-info').classList.add('hidden');
            addActivity('🔌 Wallet disconnected');
        }

        async function createActor(event) {
            event.preventDefault();
            
            // Temporarily remove wallet requirement for testing
            // if (!wallet) {
            //     alert('Please connect your wallet first!');
            //     return;
            // }

            const form = document.getElementById('actor-form');
            const editId = form.getAttribute('data-edit-id');
            const isEdit = !!editId;

            const nameElement = document.getElementById('actor-form-name');
            const typeElement = document.getElementById('actor-form-type');
            const organizationElement = document.getElementById('actor-form-organization');
            const pinElement = document.getElementById('actor-form-pin');
            const tpsElement = document.getElementById('actor-form-tps');

            console.log('Actor form elements check:');
            console.log('name element:', nameElement, 'value:', nameElement?.value);
            console.log('type element:', typeElement, 'value:', typeElement?.value);
            console.log('organization element:', organizationElement, 'value:', organizationElement?.value);
            console.log('pin element:', pinElement, 'value:', pinElement?.value);
            console.log('tps element:', tpsElement, 'value:', tpsElement?.value);

            const actorTypes = typeElement?.value ? typeElement.value.split(',').filter(t => t.trim()) : [];
            
            const formData = {
                name: nameElement?.value || '',
                actorType: actorTypes,
                organization: organizationElement?.value || '',
                pin: pinElement?.value || '',
                assignedTps: tpsElement?.value ? parseInt(tpsElement.value) : 0,
                address: null,
                farmId: null,
                farmerId: null
            };

            console.log('Actor form data:', formData);

            // Validate required fields
            if (!formData.name) {
                alert('Please enter actor name');
                return;
            }
            if (formData.actorType.length === 0) {
                alert('Please select at least one actor type using the buttons above');
                return;
            }
            if (!formData.organization) {
                alert('Please select an organization');
                return;
            }
            if (!formData.assignedTps || formData.assignedTps === 0) {
                alert('Please enter assigned TPS');
                return;
            }

            try {
                const url = isEdit ? `${API_BASE}/chain-actors/${editId}` : `${API_BASE}/chain-actors`;
                const method = isEdit ? 'PUT' : 'POST';
                
                console.log('Sending actor data to API:', JSON.stringify(formData, null, 2));
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();
                
                if (response.ok && result.success) {
                    addActivity(`✅ ${isEdit ? 'Updated' : 'Created'} actor: ${formData.name}`);
                    closeModal();
                    loadActors();
                } else {
                    throw new Error(result.message || 'Failed to ' + (isEdit ? 'update' : 'create') + ' actor');
                }
            } catch (error) {
                console.error('Error ' + (isEdit ? 'updating' : 'creating') + ' actor:', error);
                addActivity(`❌ Failed to ${isEdit ? 'update' : 'create'} actor: ${error.message}`);
            }
        }

        async function loadActors() {
            try {
                const response = await fetch(`${API_BASE}/chain-actors`);
                const result = await response.json();
                
                if (response.ok && result.success) {
                    window.currentActorsData = result.data.actors || [];
                    displayActors(window.currentActorsData);
                    addActivity(`📊 Loaded ${window.currentActorsData.length} actors`);
                } else {
                    throw new Error(result.message || 'Failed to load actors');
                }
            } catch (error) {
                console.error('Error loading actors:', error);
                addActivity(`❌ Failed to load actors: ${error.message}`);
            }
        }

        async function editActor(publicKey) {
            try {
                const response = await fetch(`${API_BASE}/chain-actors/${publicKey}`);
                const result = await response.json();
                
                if (response.ok && result.success) {
                    const actor = result.data.actor;
                    
                    // Populate form with existing data
                    document.getElementById('actor-form-name').value = actor.name || '';
                    document.getElementById('actor-form-type').value = actor.actorType?.join(', ') || '';
                    document.getElementById('actor-form-organization').value = actor.organization || '';
                    document.getElementById('actor-form-pin').value = actor.pin || '';
                    document.getElementById('actor-form-tps').value = actor.assignedTps || '';
                    
                    // Set edit mode
                    const form = document.getElementById('actor-form');
                    form.setAttribute('data-edit-id', publicKey);
                    
                    // Update modal title
                    document.querySelector('#actor-modal h2').textContent = 'Edit Chain Actor';
                    
                    // Show modal
                    document.getElementById('actor-modal').classList.remove('hidden');
                } else {
                    throw new Error(result.message || 'Failed to load actor');
                }
            } catch (error) {
                console.error('Error loading actor for edit:', error);
                addActivity(`❌ Failed to load actor: ${error.message}`);
            }
        }

        async function deleteActor(publicKey) {
            if (confirm('Are you sure you want to delete this actor?')) {
                try {
                    const response = await fetch(`${API_BASE}/chain-actors/${publicKey}`, {
                        method: 'DELETE'
                    });

                    const result = await response.json();
                    
                    if (response.ok && result.success) {
                        addActivity(`🗑️ Deleted actor: ${publicKey.slice(0,8)}`);
                        loadActors(); // Auto refresh
                    } else {
                        throw new Error(result.message || 'Failed to delete actor');
                    }
                } catch (error) {
                    console.error('Error deleting actor:', error);
                    addActivity(`❌ Failed to delete actor: ${error.message}`);
                }
            }
        }

        function displayActors(actors) {
            const tbody = document.getElementById('actors-table');
            const showAll = document.getElementById('show-all-actors').checked;
            
            // Filter actors based on checkbox state
            const filteredActors = showAll ? actors : actors.filter(actor => actor.isActive !== false);
            
            if (filteredActors.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-4 text-center text-gray-500">No actors found</td></tr>';
                return;
            }

            tbody.innerHTML = filteredActors.map(actor => `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-2 text-sm font-medium text-gray-900">${actor.name}</td>
                    <td class="px-4 py-2 text-sm text-gray-500">${actor.actorType?.join(', ') || 'N/A'}</td>
                    <td class="px-4 py-2 text-sm text-gray-500">${actor.organization}</td>
                    <td class="px-4 py-2 text-sm">
                        <span class="px-2 py-1 text-xs font-semibold rounded-full ${actor.isActive ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            ${actor.isActive ? 'Active' : 'Inactive'}
                        </span>
                    </td>
                    <td class="px-4 py-2 text-sm font-mono text-gray-500">${actor.publicKey?.substring(0, 16)}...</td>
                    <td class="px-4 py-2 text-sm">
                        ${actor.isActive !== false ? `
                            <button onclick="editActor('${actor.publicKey}')" class="bg-yellow-500 hover:bg-yellow-700 text-white text-xs py-1 px-2 rounded mr-1">
                                Edit
                            </button>
                            <button onclick="deleteActor('${actor.publicKey}')" class="bg-red-500 hover:bg-red-700 text-white text-xs py-1 px-2 rounded">
                                Delete
                            </button>
                        ` : ''}
                    </td>
                </tr>
            `).join('');
        }

        // Tab switching functionality
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Show selected tab
            document.getElementById(`${tabName}-tab`).classList.remove('hidden');
            
            // Update tab button styles
            document.querySelectorAll('.tab-button').forEach(button => {
                if (button.dataset.tab === tabName) {
                    button.className = 'tab-button py-4 px-2 border-b-2 border-primary text-primary font-medium transition-colors duration-200';
                } else {
                    button.className = 'tab-button py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-primary font-medium transition-colors duration-200';
                }
            });
            
            // Load data for the selected tab
            switch(tabName) {
                case 'chain-actors':
                    loadActors();
                    break;
                case 'production-seasons':
                    loadSeasons();
                    break;
                case 'milling':
                    loadMilledRice();
                    break;
                case 'rice-batches':
                    loadBatches();
                    break;
                case 'transactions':
                    loadTransactions();
                    break;
            }
        }

        // Production Season functions
        async function createSeason(event) {
            event.preventDefault();
            console.log('createSeason called');
            
            if (!wallet) {
                console.log('No wallet connected, proceeding without wallet for testing');
                // alert('Please connect your wallet first!');
                // return;
            }

            const form = document.getElementById('season-form');
            const editId = form.getAttribute('data-edit-id');
            const isEdit = !!editId;

            // Get all form elements first
            const farmerElement = document.getElementById('season-farmer');
            const yieldElement = document.getElementById('season-yield');
            const nameElement = document.getElementById('season-name');
            const varietyElement = document.getElementById('season-variety');
            const plantingElement = document.getElementById('season-planting');
            const harvestElement = document.getElementById('season-harvest');
            const moistureElement = document.getElementById('season-moisture');
            const irrigationElement = document.getElementById('season-irrigation');
            const fertilizersElement = document.getElementById('season-fertilizers');
            const pesticidesElement = document.getElementById('season-pesticides');
            const carbonCheckbox = document.getElementById('season-carbon-certified');
            
            if (!carbonCheckbox) {
                alert('Carbon certification checkbox not found!');
                return;
            }

            console.log('Carbon checkbox found:', carbonCheckbox);
            console.log('Carbon checkbox checked state:', carbonCheckbox.checked);
            console.log('Carbon checkbox type:', typeof carbonCheckbox.checked);

            // Ensure checkbox.checked returns a proper boolean
            const carbonCertified = carbonCheckbox ? Boolean(carbonCheckbox.checked) : false;
            console.log('Final carbon certified value:', carbonCertified);

            const formData = {
                farmerId: farmerElement?.value || '',
                cropYear: new Date().getFullYear().toString(),
                processedYieldKg: yieldElement?.value ? parseInt(yieldElement.value) : 0,
                carbonSmartCertified: carbonCertified,
                seasonName: nameElement?.value || '',
                riceVariety: varietyElement?.value || '',
                plantingDate: plantingElement?.value || '',
                harvestDate: harvestElement?.value || '',
                totalYieldKg: yieldElement?.value ? parseInt(yieldElement.value) : 0,
                moistureContent: moistureElement?.value ? parseFloat(moistureElement.value) : 14.0,
                irrigationPractice: irrigationElement?.value || '',
                fertilizersUsed: fertilizersElement?.value ? fertilizersElement.value.split(',').filter(f => f.trim()) : [],
                pesticidesUsed: pesticidesElement?.value ? pesticidesElement.value.split(',').filter(p => p.trim()) : [],
                validationStatus: 'pending'
            };
            
            // Debug each field collection for season form
            console.log('Season form elements check:');
            console.log('farmer element:', farmerElement, 'value:', farmerElement?.value);
            console.log('yield element:', yieldElement, 'value:', yieldElement?.value);
            console.log('name element:', nameElement, 'value:', nameElement?.value);
            console.log('variety element:', varietyElement, 'value:', varietyElement?.value);
            console.log('planting element:', plantingElement, 'value:', plantingElement?.value);
            console.log('harvest element:', harvestElement, 'value:', harvestElement?.value);
            console.log('moisture element:', moistureElement, 'value:', moistureElement?.value);
            console.log('irrigation element:', irrigationElement, 'value:', irrigationElement?.value);
            console.log('fertilizers element:', fertilizersElement, 'value:', fertilizersElement?.value);
            console.log('pesticides element:', pesticidesElement, 'value:', pesticidesElement?.value);
            console.log('carbon checkbox:', carbonCheckbox, 'checked:', carbonCheckbox?.checked);
            
            console.log('Season form data:', formData);
            console.log('carbonSmartCertified value:', formData.carbonSmartCertified);
            console.log('carbonSmartCertified type:', typeof formData.carbonSmartCertified);

            try {
                const url = isEdit ? `${API_BASE}/production-seasons/${editId}` : `${API_BASE}/production-seasons`;
                const method = isEdit ? 'PUT' : 'POST';
                
                console.log('Sending to API:', JSON.stringify(formData, null, 2));
                
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();
                console.log('Season API response:', response.status, result);
                
                if (response.ok && result.success) {
                    addActivity(`✅ ${isEdit ? 'Updated' : 'Created'} season: ${formData.seasonName}`);
                    closeModal();
                    loadSeasons();
                } else {
                    console.error('Season creation failed:', result);
                    throw new Error(result.message || `Failed to ${isEdit ? 'update' : 'create'} season`);
                }
            } catch (error) {
                console.error(`Error ${isEdit ? 'updating' : 'creating'} season:`, error);
                addActivity(`❌ Failed to ${isEdit ? 'update' : 'create'} season: ${error.message}`);
                alert(`Failed to ${isEdit ? 'update' : 'create'} season: ${error.message}`);
            }
        }

        async function loadSeasons() {
            try {
                const response = await fetch(`${API_BASE}/production-seasons`);
                const result = await response.json();
                
                if (response.ok && result.success) {
                    const seasons = result.data.seasons || [];
                    
                    // Fetch farmer names for each season
                    for (let season of seasons) {
                        if (season.farmerId) {
                            try {
                                const actorResponse = await fetch(`${API_BASE}/chain-actors/${season.farmerId}`);
                                const actorResult = await actorResponse.json();
                                if (actorResponse.ok && actorResult.success) {
                                    season.farmerName = actorResult.data.actor?.name || 'Unknown Farmer';
                                }
                            } catch (error) {
                                console.log('Could not fetch farmer name for season:', season.publicKey);
                                season.farmerName = 'Unknown Farmer';
                            }
                        }
                    }
                    
                    window.currentSeasonsData = seasons;
                    displaySeasons(window.currentSeasonsData);
                    addActivity(`📊 Loaded ${seasons.length} seasons`);
                } else {
                    throw new Error(result.message || 'Failed to load seasons');
                }
            } catch (error) {
                console.error('Error loading seasons:', error);
                addActivity(`❌ Failed to load seasons: ${error.message}`);
            }
        }

        function displaySeasons(seasons) {
            const tbody = document.getElementById('seasons-table');
            const showAll = document.getElementById('show-all-seasons').checked;
            
            // Filter seasons based on checkbox state
            const filteredSeasons = showAll ? seasons : seasons.filter(season => season.isActive !== false);
            
            if (filteredSeasons.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-4 text-center text-gray-500">No seasons found</td></tr>';
                return;
            }

            tbody.innerHTML = filteredSeasons.map(season => `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-2 text-sm font-medium text-gray-900">${season.seasonName || season.cropYear + ' Season' || 'Season ' + season.publicKey.slice(0,8)}</td>
                    <td class="px-4 py-2 text-sm text-gray-500">${season.farmerName || 'Loading...'}</td>
                    <td class="px-4 py-2 text-sm text-gray-500">${season.riceVariety || 'Standard Rice'}</td>
                    <td class="px-4 py-2 text-sm text-gray-500">${season.totalYieldKg || season.processedYieldKg || 'N/A'} kg</td>
                    <td class="px-4 py-2 text-sm">
                        <span class="px-2 py-1 text-xs font-semibold rounded-full ${season.carbonSmartCertified ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                            ${season.carbonSmartCertified ? 'Certified' : 'Not Certified'}
                        </span>
                    </td>
                    <td class="px-4 py-2 text-sm">
                        ${season.isActive !== false ? `
                            <button onclick="editSeason('${season.publicKey}')" class="bg-yellow-500 hover:bg-yellow-700 text-white text-xs py-1 px-2 rounded mr-1">
                                Edit
                            </button>
                            <button onclick="deleteSeason('${season.publicKey}')" class="bg-red-500 hover:bg-red-700 text-white text-xs py-1 px-2 rounded">
                                Delete
                            </button>
                        ` : ''}
                    </td>
                </tr>
            `).join('');
        }

        async function loadMilledRice() {
            try {
                const response = await fetch(`${API_BASE}/milled-rice`);
                const result = await response.json();
                
                if (response.ok && result.success) {
                    const milledRice = result.data.milledRice || [];
                    
                    // Fetch season names for each milled rice
                    for (let rice of milledRice) {
                        if (rice.seasonId) {
                            try {
                                const seasonResponse = await fetch(`${API_BASE}/production-seasons/${rice.seasonId}`);
                                const seasonResult = await seasonResponse.json();
                                if (seasonResponse.ok && seasonResult.success) {
                                    rice.seasonName = seasonResult.data.season?.seasonName || 'Unknown Season';
                                }
                            } catch (error) {
                                console.log('Could not fetch season name for milled rice:', rice.publicKey);
                                rice.seasonName = 'Unknown Season';
                            }
                        }
                    }
                    
                    window.currentMilledRiceData = milledRice;
                    displayMilledRice(window.currentMilledRiceData);
                    addActivity(`📊 Loaded ${milledRice.length} milled rice records`);
                } else {
                    throw new Error(result.message || 'Failed to load milled rice');
                }
            } catch (error) {
                console.error('Error loading milled rice:', error);
                addActivity(`❌ Failed to load milled rice: ${error.message}`);
            }
        }

        function displayMilledRice(milledRice) {
            const tbody = document.getElementById('milling-table');
            const showAll = document.getElementById('show-all-milled').checked;
            
            // Filter milled rice based on checkbox state
            const filteredMilledRice = showAll ? milledRice : milledRice.filter(rice => rice.isActive !== false);
            
            if (filteredMilledRice.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-4 text-center text-gray-500">No milled rice found</td></tr>';
                return;
            }

            tbody.innerHTML = filteredMilledRice.map(rice => `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-2 text-sm font-medium text-gray-900">${rice.machineName || 'Machine ' + rice.publicKey.slice(0,8)}</td>
                    <td class="px-4 py-2 text-sm text-gray-500">${rice.seasonName || 'Loading...'}</td>
                    <td class="px-4 py-2 text-sm text-gray-500">${rice.totalWeightProcessedKg || 'N/A'} kg</td>
                    <td class="px-4 py-2 text-sm text-gray-500">${rice.moistureContent || 'N/A'}%</td>
                    <td class="px-4 py-2 text-sm">
                        <span class="px-2 py-1 text-xs font-semibold rounded-full ${
                            rice.validationStatus === 'validated' ? 'bg-green-100 text-green-800' :
                            rice.validationStatus === 'pending' ? 'bg-yellow-100 text-yellow-800' :
                            'bg-red-100 text-red-800'
                        }">
                            ${rice.validationStatus || 'pending'}
                        </span>
                    </td>
                    <td class="px-4 py-2 text-sm">
                        ${rice.isActive !== false ? `
                            <button onclick="editMilledRice('${rice.publicKey}')" class="bg-yellow-500 hover:bg-yellow-700 text-white text-xs py-1 px-2 rounded mr-1">
                                Edit
                            </button>
                            <button onclick="deleteMilledRice('${rice.publicKey}')" class="bg-red-500 hover:bg-red-700 text-white text-xs py-1 px-2 rounded">
                                Delete
                            </button>
                        ` : ''}
                    </td>
                </tr>
            `).join('');
        }

        // Milled Rice functions
        async function createMilledRice(event) {
            event.preventDefault();
            console.log('createMilledRice called');
            
            if (!wallet) {
                console.log('No wallet connected, proceeding without wallet for testing');
            }

            const form = document.getElementById('milling-form');
            const editId = form.getAttribute('data-edit-id');
            const isEdit = !!editId;

            const formData = {
                seasonId: document.getElementById('milling-season-id')?.value || '',
                machineName: document.getElementById('milling-machine-name')?.value || '',
                totalWeightProcessedKg: document.getElementById('milling-weight')?.value ? parseInt(document.getElementById('milling-weight').value) : 0,
                moistureContent: document.getElementById('milling-moisture')?.value ? parseFloat(document.getElementById('milling-moisture').value) : 14.0,
                photoUrls: document.getElementById('milling-photos')?.value ? document.getElementById('milling-photos').value.split('\n').filter(url => url.trim()) : [],
                validationStatus: 'pending'
            };

            console.log('Milled rice form data:', formData);

            // Validate required fields
            if (!formData.seasonId) {
                alert('Please select a season');
                return;
            }
            if (!formData.machineName) {
                alert('Please enter machine name');
                return;
            }
            if (!formData.totalWeightProcessedKg || formData.totalWeightProcessedKg === 0) {
                alert('Please enter processed weight');
                return;
            }

            try {
                const url = isEdit ? `${API_BASE}/milled-rice/${editId}` : `${API_BASE}/milled-rice`;
                const method = isEdit ? 'PUT' : 'POST';
                
                console.log('Sending milled rice data to API:', JSON.stringify(formData, null, 2));
                
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();
                console.log('Milled rice API response:', response.status, result);
                
                if (response.ok) {
                    addActivity(`✅ ${isEdit ? 'Updated' : 'Created'} milled rice: ${formData.machineName}`);
                    closeModal();
                    loadMilledRice();
                } else {
                    throw new Error(result.message || `Failed to ${isEdit ? 'update' : 'create'} milled rice`);
                }
            } catch (error) {
                console.error('Error ' + (isEdit ? 'updating' : 'creating') + ' milled rice:', error);
                addActivity(`❌ Failed to ${isEdit ? 'update' : 'create'} milled rice: ${error.message}`);
            }
        }

        // Rice Batch functions
        async function createBatch(event) {
            event.preventDefault();
            console.log('createBatch called');
            
            if (!wallet) {
                console.log('No wallet connected, proceeding without wallet for testing');
                // alert('Please connect your wallet first!');
                // return;
            }

            const form = document.getElementById('batch-form');
            const editId = form.getAttribute('data-edit-id');
            const isEdit = !!editId;

            const seasonId = document.getElementById('batch-season-id').value;
            const validationId = document.getElementById('batch-validation-id').value;
            const dryingId = document.getElementById('batch-drying-id').value;
            
            // Validate required fields
            if (!seasonId || !validationId || !dryingId) {
                alert('Please select Season, Validator, and Dryer before creating the batch.');
                return;
            }

            // Debug each field collection for batch form
            const quantityElement = document.getElementById('batch-quantity');
            const statusElement = document.getElementById('batch-status');
            
            console.log('Batch form elements check:');
            console.log('quantity element:', quantityElement, 'value:', quantityElement?.value);
            console.log('status element:', statusElement, 'value:', statusElement?.value);
            console.log('seasonId:', seasonId);
            console.log('validationId:', validationId);
            console.log('dryingId:', dryingId);

            const formData = {
                qrCode: `QR${Date.now()}`,
                batchWeightKg: quantityElement?.value ? parseInt(quantityElement.value) : 0,
                seasonId: seasonId,
                validator: validationId,
                dryingId: dryingId,
                status: statusElement?.value && statusElement.value !== '' ? statusElement.value : 'forSale',
                moistureContent: 14.0,
                pricePerKg: 50.0
            };

            console.log('Batch form data before sending:', JSON.stringify(formData, null, 2));

            try {
                const url = isEdit ? `${API_BASE}/rice-batches/${editId}` : `${API_BASE}/rice-batches`;
                const method = isEdit ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();
                
                if (response.ok) {
                    addActivity(`✅ ${isEdit ? 'Updated' : 'Created'} batch: ${formData.qrCode}`);
                    closeModal();
                    loadBatches();
                } else {
                    throw new Error(result.message || `Failed to ${isEdit ? 'update' : 'create'} batch`);
                }
            } catch (error) {
                console.error(`Error ${isEdit ? 'updating' : 'creating'} batch:`, error);
                addActivity(`❌ Failed to ${isEdit ? 'update' : 'create'} batch: ${error.message}`);
                alert(`Failed to ${isEdit ? 'update' : 'create'} batch: ${error.message}`);
            }
        }

        async function loadBatches() {
            try {
                const response = await fetch(`${API_BASE}/rice-batches`);
                const result = await response.json();
                
                if (response.ok && result.success) {
                    const batches = result.data.batches || [];
                    
                    // Fetch season names for each batch
                    for (let batch of batches) {
                        if (batch.seasonId) {
                            try {
                                const seasonResponse = await fetch(`${API_BASE}/production-seasons/${batch.seasonId}`);
                                const seasonResult = await seasonResponse.json();
                                if (seasonResponse.ok && seasonResult.success) {
                                    batch.seasonName = seasonResult.data.season?.seasonName || 'Unknown Season';
                                }
                            } catch (error) {
                                console.log('Could not fetch season name for batch:', batch.publicKey);
                                batch.seasonName = 'Unknown Season';
                            }
                        }
                    }
                    
                    window.currentBatchesData = batches;
                    displayBatches(window.currentBatchesData);
                    addActivity(`📊 Loaded ${batches.length} batches`);
                } else {
                    throw new Error(result.message || 'Failed to load batches');
                }
            } catch (error) {
                console.error('Error loading batches:', error);
                addActivity(`❌ Failed to load batches: ${error.message}`);
            }
        }

        function displayBatches(batches) {
            const tbody = document.getElementById('batches-table');
            const showAll = document.getElementById('show-all-batches').checked;
            
            // Filter batches based on checkbox state
            const filteredBatches = showAll ? batches : batches.filter(batch => batch.isActive !== false);
            
            if (filteredBatches.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-4 text-center text-gray-500">No batches found</td></tr>';
                return;
            }

            tbody.innerHTML = filteredBatches.map(batch => `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-2 text-sm font-medium text-gray-900">${batch.qrCode || 'QR-' + batch.publicKey.slice(0,8)}</td>
                    <td class="px-4 py-2 text-sm text-gray-500">${batch.seasonName || 'Loading...'}</td>
                    <td class="px-4 py-2 text-sm text-gray-500">${batch.totalWeightKg || 'N/A'} kg</td>
                    <td class="px-4 py-2 text-sm text-gray-500">${batch.pricePerKg || 'N/A'}</td>
                    <td class="px-4 py-2 text-sm">
                        <span class="px-2 py-1 text-xs font-semibold rounded-full ${
                            batch.status === 'for_sale' ? 'bg-green-100 text-green-800' :
                            batch.status === 'stock' ? 'bg-blue-100 text-blue-800' :
                            'bg-gray-100 text-gray-800'
                        }">
                            ${batch.status || 'stock'}
                        </span>
                    </td>
                    <td class="px-4 py-2 text-sm">
                        ${batch.isActive !== false ? `
                            <button onclick="editBatch('${batch.publicKey}')" class="bg-yellow-500 hover:bg-yellow-700 text-white text-xs py-1 px-2 rounded mr-1">
                                Edit
                            </button>
                            <button onclick="deleteBatch('${batch.publicKey}')" class="bg-red-500 hover:bg-red-700 text-white text-xs py-1 px-2 rounded">
                                Delete
                            </button>
                        ` : ''}
                    </td>
                </tr>
            `).join('');
        }

        // Transaction functions
        async function createTransaction(event) {
            event.preventDefault();
            console.log('createTransaction called');
            
            if (!wallet) {
                console.log('No wallet connected, proceeding without wallet for testing');
                // alert('Please connect your wallet first!');
                // return;
            }

            const form = document.getElementById('transaction-form');
            const editId = form.getAttribute('data-edit-id');
            const isEdit = !!editId;

            const formData = {
                batchIds: [document.getElementById('transaction-batch').value],
                toActorId: document.getElementById('transaction-to').value,
                fromActorId: document.getElementById('transaction-from').value,
                pricePerKg: parseFloat(document.getElementById('transaction-amount').value),
                paymentMethod: document.getElementById('transaction-payment').value,
                status: document.getElementById('transaction-status').value,
                moisture: 14.0,
                paymentReference: [],
                geotagging: []
            };

            try {
                const url = isEdit ? `${API_BASE}/chain-transactions/${editId}` : `${API_BASE}/chain-transactions`;
                const method = isEdit ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();
                
                if (response.ok) {
                    addActivity(`✅ ${isEdit ? 'Updated' : 'Created'} transaction`);
                    closeModal();
                    loadTransactions();
                } else {
                    throw new Error(result.message || `Failed to ${isEdit ? 'update' : 'create'} transaction`);
                }
            } catch (error) {
                console.error(`Error ${isEdit ? 'updating' : 'creating'} transaction:`, error);
                addActivity(`❌ Failed to ${isEdit ? 'update' : 'create'} transaction: ${error.message}`);
                alert(`Failed to ${isEdit ? 'update' : 'create'} transaction: ${error.message}`);
            }
        }

        async function loadTransactions() {
            try {
                const response = await fetch(`${API_BASE}/chain-transactions`);
                const result = await response.json();
                
                if (response.ok && result.success) {
                    const transactions = result.data.transactions || [];
                    
                    // Fetch actor and batch names for each transaction
                    for (let tx of transactions) {
                        // Fetch from actor name
                        if (tx.fromActor) {
                            try {
                                const fromActorResponse = await fetch(`${API_BASE}/chain-actors/${tx.fromActor}`);
                                const fromActorResult = await fromActorResponse.json();
                                if (fromActorResponse.ok && fromActorResult.success) {
                                    tx.fromActorName = fromActorResult.data.actor?.name || 'Unknown Actor';
                                }
                            } catch (error) {
                                console.log('Could not fetch from actor name for transaction:', tx.publicKey);
                                tx.fromActorName = 'Unknown Actor';
                            }
                        }
                        
                        // Fetch to actor name
                        if (tx.toActor) {
                            try {
                                const toActorResponse = await fetch(`${API_BASE}/chain-actors/${tx.toActor}`);
                                const toActorResult = await toActorResponse.json();
                                if (toActorResponse.ok && toActorResult.success) {
                                    tx.toActorName = toActorResult.data.actor?.name || 'Unknown Actor';
                                }
                            } catch (error) {
                                console.log('Could not fetch to actor name for transaction:', tx.publicKey);
                                tx.toActorName = 'Unknown Actor';
                            }
                        }
                        
                        // Fetch batch QR code
                        if (tx.batchId) {
                            try {
                                const batchResponse = await fetch(`${API_BASE}/rice-batches/${tx.batchId}`);
                                const batchResult = await batchResponse.json();
                                if (batchResponse.ok && batchResult.success) {
                                    tx.batchQrCode = batchResult.data.batch?.qrCode || 'Unknown Batch';
                                }
                            } catch (error) {
                                console.log('Could not fetch batch QR code for transaction:', tx.publicKey);
                                tx.batchQrCode = 'Unknown Batch';
                            }
                        }
                    }
                    
                    window.currentTransactionsData = transactions;
                    displayTransactions(window.currentTransactionsData);
                    addActivity(`📊 Loaded ${transactions.length} transactions`);
                } else {
                    throw new Error(result.message || 'Failed to load transactions');
                }
            } catch (error) {
                console.error('Error loading transactions:', error);
                addActivity(`❌ Failed to load transactions: ${error.message}`);
            }
        }

        function displayTransactions(transactions) {
            const tbody = document.getElementById('transactions-table');
            const showAll = document.getElementById('show-all-transactions').checked;
            
            // Filter transactions based on checkbox state
            const filteredTransactions = showAll ? transactions : transactions.filter(tx => tx.isActive !== false);
            
            if (filteredTransactions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-4 text-center text-gray-500">No transactions found</td></tr>';
                return;
            }

            tbody.innerHTML = filteredTransactions.map(tx => `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-2 text-sm font-medium text-gray-900">${tx.fromActorName || 'Loading...'}</td>
                    <td class="px-4 py-2 text-sm text-gray-500">${tx.toActorName || 'Loading...'}</td>
                    <td class="px-4 py-2 text-sm text-gray-500">${tx.batchQrCode || 'Loading...'}</td>
                    <td class="px-4 py-2 text-sm text-gray-500">${tx.totalAmount || 'N/A'}</td>
                    <td class="px-4 py-2 text-sm">
                        <span class="px-2 py-1 text-xs font-semibold rounded-full ${
                            tx.status === 'completed' ? 'bg-green-100 text-green-800' :
                            tx.status === 'pending' ? 'bg-yellow-100 text-yellow-800' :
                            tx.status === 'cancelled' ? 'bg-red-100 text-red-800' :
                            'bg-blue-100 text-blue-800'
                        }">
                            ${tx.status || 'pending'}
                        </span>
                    </td>
                    <td class="px-4 py-2 text-sm">
                        ${tx.isActive !== false ? `
                            <button onclick="editTransaction('${tx.publicKey}')" class="bg-yellow-500 hover:bg-yellow-700 text-white text-xs py-1 px-2 rounded mr-1">
                                Edit
                            </button>
                            <button onclick="deleteTransaction('${tx.publicKey}')" class="bg-red-500 hover:bg-red-700 text-white text-xs py-1 px-2 rounded">
                                Delete
                            </button>
                        ` : ''}
                    </td>
                </tr>
            `).join('');
        }

        // Edit and Delete functions
        async function editSeason(publicKey) {
            try {
                const response = await fetch(`${API_BASE}/production-seasons/${publicKey}`);
                const result = await response.json();
                
                if (response.ok && result.success) {
                    const season = result.data.data || result.data;
                    
                    // Populate form with existing data
                    document.getElementById('season-name').value = season.seasonName || '';
                    document.getElementById('season-variety').value = season.riceVariety || '';
                    document.getElementById('season-planting').value = season.plantingDate || '';
                    document.getElementById('season-harvest').value = season.harvestDate || '';
                    document.getElementById('season-yield').value = season.totalYieldKg || season.processedYieldKg || '';
                    document.getElementById('season-moisture').value = season.moistureContent || '';
                    document.getElementById('season-irrigation').value = season.irrigationPractice || '';
                    document.getElementById('season-carbon-certified').checked = season.carbonSmartCertified || false;
                    
                    // Set farmer dropdown
                    const farmerSelect = document.getElementById('season-farmer');
                    if (farmerSelect) {
                        farmerSelect.value = season.farmerId || '';
                    }
                    
                    // Handle fertilizers chips
                    const fertilizers = season.fertilizers || [];
                    document.getElementById('season-fertilizers').value = Array.isArray(fertilizers) ? fertilizers.join(',') : fertilizers;
                    document.querySelectorAll('#fertilizer-chips .chip-button').forEach(btn => {
                        btn.classList.remove('active');
                        if (fertilizers.includes && fertilizers.includes(btn.dataset.value)) {
                            btn.classList.add('active');
                        } else if (typeof fertilizers === 'string' && fertilizers.includes(btn.dataset.value)) {
                            btn.classList.add('active');
                        }
                    });
                    
                    // Handle pesticides chips
                    const pesticides = season.pesticides || [];
                    document.getElementById('season-pesticides').value = Array.isArray(pesticides) ? pesticides.join(',') : pesticides;
                    document.querySelectorAll('#pesticide-chips .chip-button').forEach(btn => {
                        btn.classList.remove('active');
                        if (pesticides.includes && pesticides.includes(btn.dataset.value)) {
                            btn.classList.add('active');
                        } else if (typeof pesticides === 'string' && pesticides.includes(btn.dataset.value)) {
                            btn.classList.add('active');
                        }
                    });
                    
                    // Change form to edit mode
                    const form = document.getElementById('season-form');
                    form.setAttribute('data-edit-id', publicKey);
                    
                    // Update modal title and button text
                    const modalTitle = document.querySelector('#season-modal h2');
                    if (modalTitle) modalTitle.textContent = 'Edit Production Season';
                    
                    const submitButton = form.querySelector('button[type="submit"]');
                    if (submitButton) submitButton.textContent = 'Update Season';
                    
                    // Open the modal
                    openModal('season-modal');
                    
                    addActivity(`✏️ Editing season: ${season.seasonName || publicKey.slice(0,8)}`);
                } else {
                    throw new Error(result.message || 'Failed to load season data');
                }
            } catch (error) {
                console.error('Error loading season for edit:', error);
                addActivity(`❌ Failed to load season: ${error.message}`);
            }
        }

        async function deleteSeason(publicKey) {
            if (confirm('Are you sure you want to delete this season?')) {
                try {
                    const response = await fetch(`${API_BASE}/production-seasons/${publicKey}`, {
                        method: 'DELETE'
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok) {
                        addActivity(`🗑️ Deleted season: ${publicKey.slice(0,8)}`);
                        loadSeasons(); // Auto refresh
                    } else {
                        throw new Error(result.message || 'Failed to delete season');
                    }
                } catch (error) {
                    console.error('Error deleting season:', error);
                    addActivity(`❌ Failed to delete season: ${error.message}`);
                }
            }
        }

        async function editMilledRice(publicKey) {
            try {
                const response = await fetch(`${API_BASE}/milled-rice/${publicKey}`);
                const result = await response.json();
                
                if (response.ok && result.success) {
                    const rice = result.data.data || result.data;
                    
                    // Populate form with existing data using correct field mappings
                    const seasonSelect = document.getElementById('milling-season-id');
                    const machineInput = document.getElementById('milling-machine-name');
                    const weightInput = document.getElementById('milling-weight');
                    const moistureInput = document.getElementById('milling-moisture');
                    const photosTextarea = document.getElementById('milling-photos');
                    
                    if (seasonSelect) seasonSelect.value = rice.seasonId || '';
                    if (machineInput) machineInput.value = rice.machineName || '';
                    if (weightInput) weightInput.value = rice.totalWeightProcessedKg || rice.totalWeightKg || '';
                    if (moistureInput) moistureInput.value = rice.moistureContent || rice.moisture || '';
                    if (photosTextarea) photosTextarea.value = Array.isArray(rice.photoUrls) ? rice.photoUrls.join('\n') : (rice.photoUrls || '');
                    
                    // Change form to edit mode
                    const form = document.getElementById('milling-form');
                    form.setAttribute('data-edit-id', publicKey);
                    
                    // Update modal title and button text
                    const modalTitle = document.querySelector('#milling-modal h2');
                    if (modalTitle) modalTitle.textContent = 'Edit Milled Rice';
                    
                    const submitButton = form.querySelector('button[type="submit"]');
                    if (submitButton) submitButton.textContent = 'Update Milled Rice';
                    
                    // Open the modal
                    openModal('milling-modal');
                    
                    addActivity(`✏️ Editing milled rice: ${rice.machineName || publicKey.slice(0,8)}`);
                } else {
                    throw new Error(result.message || 'Failed to load milled rice data');
                }
            } catch (error) {
                console.error('Error loading milled rice for edit:', error);
                addActivity(`❌ Failed to load milled rice: ${error.message}`);
            }
        }

        async function deleteMilledRice(publicKey) {
            if (confirm('Are you sure you want to delete this milled rice record?')) {
                try {
                    const response = await fetch(`${API_BASE}/milled-rice/${publicKey}`, {
                        method: 'DELETE'
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok) {
                        addActivity(`🗑️ Deleted milled rice: ${publicKey.slice(0,8)}`);
                        loadMilledRice(); // Auto refresh
                    } else {
                        throw new Error(result.message || 'Failed to delete milled rice');
                    }
                } catch (error) {
                    console.error('Error deleting milled rice:', error);
                    addActivity(`❌ Failed to delete milled rice: ${error.message}`);
                }
            }
        }

        async function editBatch(publicKey) {
            try {
                const response = await fetch(`${API_BASE}/rice-batches/${publicKey}`);
                const result = await response.json();
                
                if (response.ok && result.success) {
                    const batch = result.data.data || result.data;
                    // Populate form with existing data
                    document.getElementById('batch-variety').value = batch.riceVariety || '';
                    document.getElementById('batch-quantity').value = batch.totalQuantityKg || '';
                    document.getElementById('batch-harvest-date').value = batch.harvestDate || '';
                    
                    // Change form to edit mode
                    const form = document.getElementById('batch-form');
                    form.setAttribute('data-edit-id', publicKey);
                    form.querySelector('button[type="submit"]').textContent = 'Update Batch';
                    
                    addActivity(`✏️ Editing batch: ${batch.riceVariety || publicKey.slice(0,8)}`);
                } else {
                    throw new Error(result.message || 'Failed to load batch data');
                }
            } catch (error) {
                console.error('Error loading batch for edit:', error);
                addActivity(`❌ Failed to load batch: ${error.message}`);
            }
        }

        async function deleteBatch(publicKey) {
            if (confirm('Are you sure you want to delete this batch?')) {
                try {
                    const response = await fetch(`${API_BASE}/rice-batches/${publicKey}`, {
                        method: 'DELETE'
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok) {
                        addActivity(`🗑️ Deleted batch: ${publicKey.slice(0,8)}`);
                        loadBatches(); // Auto refresh
                    } else {
                        throw new Error(result.message || 'Failed to delete batch');
                    }
                } catch (error) {
                    console.error('Error deleting batch:', error);
                    addActivity(`❌ Failed to delete batch: ${error.message}`);
                }
            }
        }

        async function editTransaction(publicKey) {
            try {
                const response = await fetch(`${API_BASE}/chain-transactions/${publicKey}`);
                const result = await response.json();
                
                if (response.ok && result.success) {
                    const tx = result.data.data || result.data;
                    
                    // Populate form with existing data using correct element IDs
                    const batchSelect = document.getElementById('transaction-batch');
                    const fromSelect = document.getElementById('transaction-from');
                    const toSelect = document.getElementById('transaction-to');
                    const amountInput = document.getElementById('transaction-amount');
                    const paymentSelect = document.getElementById('transaction-payment');
                    const statusSelect = document.getElementById('transaction-status');
                    
                    if (batchSelect) batchSelect.value = tx.batchId || '';
                    if (fromSelect) fromSelect.value = tx.fromActorId || '';
                    if (toSelect) toSelect.value = tx.toActorId || '';
                    if (amountInput) amountInput.value = tx.amount || tx.pricePerKg || '';
                    if (paymentSelect) paymentSelect.value = tx.paymentMethod || '';
                    if (statusSelect) statusSelect.value = tx.status || '';
                    
                    // Change form to edit mode
                    const form = document.getElementById('transaction-form');
                    form.setAttribute('data-edit-id', publicKey);
                    
                    // Update modal title and button text
                    const modalTitle = document.querySelector('#transaction-modal h2');
                    if (modalTitle) modalTitle.textContent = 'Edit Transaction';
                    
                    const submitButton = form.querySelector('button[type="submit"]');
                    if (submitButton) submitButton.textContent = 'Update Transaction';
                    
                    // Show the modal
                    document.getElementById('transaction-modal').classList.add('show');
                    
                    addActivity(`✏️ Editing transaction: ${tx.batchId || publicKey.slice(0,8)}`);
                } else {
                    throw new Error(result.message || 'Failed to load transaction data');
                }
            } catch (error) {
                console.error('Error loading transaction for edit:', error);
                addActivity(`❌ Failed to load transaction: ${error.message}`);
            }
        }

        async function deleteTransaction(publicKey) {
            if (confirm('Are you sure you want to delete this transaction?')) {
                try {
                    const response = await fetch(`${API_BASE}/chain-transactions/${publicKey}`, {
                        method: 'DELETE'
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok) {
                        addActivity(`🗑️ Deleted transaction: ${publicKey.slice(0,8)}`);
                        loadTransactions(); // Auto refresh
                    } else {
                        throw new Error(result.message || 'Failed to delete transaction');
                    }
                } catch (error) {
                    console.error('Error deleting transaction:', error);
                    addActivity(`❌ Failed to delete transaction: ${error.message}`);
                }
            }
        }

        function addActivity(message) {
            // Add to all activity logs
            const activityLogs = ['activity-log', 'seasons-activity-log', 'milling-activity-log', 'batches-activity-log', 'transactions-activity-log'];
            
            activityLogs.forEach(logId => {
                const activityLog = document.getElementById(logId);
                if (!activityLog) return;
                
                const timestamp = new Date().toLocaleTimeString();
                const entry = document.createElement('div');
                entry.className = 'text-sm mb-2 pb-2 border-b border-gray-200';
                entry.innerHTML = `<span class="text-gray-400">[${timestamp}]</span> ${message}`;
                
                if (activityLog.children.length === 1 && activityLog.children[0].textContent.includes('Activity will appear here')) {
                    activityLog.innerHTML = '';
                }
                
                activityLog.insertBefore(entry, activityLog.firstChild);
                
                // Keep only last 10 entries
                while (activityLog.children.length > 10) {
                    activityLog.removeChild(activityLog.lastChild);
                }
            });
        }

        // Add batch tracker functionality
        async function loadBatchTracker() {
            try {
                const response = await fetch(`${API_BASE}/rice-batches`);
                const data = await response.json();
                
                const batchSelector = document.getElementById('batch-selector');
                batchSelector.innerHTML = '<option value="">Select a batch...</option>';
                
                if (data.success && data.data && data.data.batches) {
                    data.data.batches.forEach(batch => {
                        const option = document.createElement('option');
                        option.value = batch.publicKey;
                        option.textContent = `${batch.qrCode} - ${batch.batchWeightKg}kg`;
                        batchSelector.appendChild(option);
                    });
                } else {
                    console.log('No batches found or invalid response structure:', data);
                }
            } catch (error) {
                console.error('Error loading batches:', error);
            }
        }

        async function displayBatchDetails(batchId) {
            if (!batchId) {
                document.getElementById('batch-details').classList.add('hidden');
                return;
            }

            try {
                // Load batch details
                const batchResponse = await fetch(`${API_BASE}/rice-batches`);
                const batchData = await batchResponse.json();
                const batch = batchData.data.batches.find(b => b.publicKey === batchId);

                if (!batch) return;

                // Display batch information
                document.getElementById('batch-qr-code').textContent = batch.qrCode;
                document.getElementById('batch-weight').textContent = batch.batchWeightKg;
                document.getElementById('batch-moisture').textContent = batch.moistureContent;
                document.getElementById('batch-price').textContent = batch.pricePerKg;
                document.getElementById('batch-blockchain-tx').textContent = batch.blockchainTx || 'N/A';
                
                const statusElement = document.getElementById('batch-status-display');
                statusElement.textContent = batch.status;
                statusElement.className = `px-2 py-1 rounded text-sm ${batch.status === 'forSale' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}`;

                // Load production season details
                if (batch.seasonId) {
                    const seasonResponse = await fetch(`${API_BASE}/production-seasons`);
                    const seasonData = await seasonResponse.json();
                    const season = seasonData.data.seasons.find(s => s.publicKey === batch.seasonId);
                    
                    if (season) {
                        document.getElementById('season-crop-year').textContent = season.cropYear;
                        document.getElementById('season-variety').textContent = season.variety || 'N/A';
                        document.getElementById('season-planting-date').textContent = season.plantingDate ? new Date(season.plantingDate).toLocaleDateString() : 'N/A';
                        document.getElementById('season-harvest-date').textContent = season.harvestDate ? new Date(season.harvestDate).toLocaleDateString() : 'N/A';
                        document.getElementById('season-total-yield').textContent = season.totalYieldKg || 'N/A';
                        document.getElementById('season-carbon-certified').textContent = season.carbonSmartCertified ? 'Yes' : 'No';
                    }
                }

                // Load milling information
                if (batch.millingId) {
                    const millingResponse = await fetch(`${API_BASE}/milled-rice`);
                    const millingData = await millingResponse.json();
                    const milling = millingData.data.milledRice.find(m => m.publicKey === batch.millingId);
                    
                    if (milling) {
                        document.getElementById('milling-type').textContent = milling.millingType;
                        document.getElementById('milling-quality').textContent = milling.quality;
                        document.getElementById('milling-total-weight').textContent = milling.totalWeightKg;
                        document.getElementById('milling-processed-weight').textContent = milling.totalWeightProcessedKg;
                        document.getElementById('milling-moisture').textContent = milling.moisture;
                    }
                }

                // Load current holder information
                if (batch.currentHolderId) {
                    const actorResponse = await fetch(`${API_BASE}/chain-actors`);
                    const actorData = await actorResponse.json();
                    const actor = actorData.data.actors.find(a => a.publicKey === batch.currentHolderId);
                    
                    if (actor) {
                        document.getElementById('actor-name').textContent = actor.name;
                        document.getElementById('actor-type').textContent = actor.actorType.join(', ');
                        document.getElementById('actor-organization').textContent = actor.organization;
                        document.getElementById('actor-tps').textContent = actor.assignedTps;
                    }
                }

                // Load transaction history
                const transactionResponse = await fetch(`${API_BASE}/chain-transactions`);
                const transactionData = await transactionResponse.json();
                const relatedTransactions = transactionData.data.transactions.filter(t => 
                    t.batchIds && t.batchIds.includes(batchId)
                );

                const transactionHistory = document.getElementById('transaction-history');
                transactionHistory.innerHTML = '';

                if (relatedTransactions.length === 0) {
                    transactionHistory.innerHTML = '<p class="text-gray-500">No transactions found for this batch.</p>';
                } else {
                    relatedTransactions.forEach(transaction => {
                        const transactionDiv = document.createElement('div');
                        transactionDiv.className = 'bg-white p-3 rounded border';
                        transactionDiv.innerHTML = `
                            <div class="flex justify-between items-start">
                                <div>
                                    <div class="font-medium">Transaction: ${transaction.publicKey.substring(0, 8)}...</div>
                                    <div class="text-sm text-gray-600">From: ${transaction.fromActorId ? transaction.fromActorId.substring(0, 8) + '...' : 'N/A'}</div>
                                    <div class="text-sm text-gray-600">To: ${transaction.toActorId.substring(0, 8)}...</div>
                                    <div class="text-sm text-gray-600">Price: $${transaction.pricePerKg}/kg</div>
                                </div>
                                <div class="text-right">
                                    <div class="text-sm font-medium ${transaction.status === 'completed' ? 'text-green-600' : 'text-yellow-600'}">${transaction.status}</div>
                                    <div class="text-xs text-gray-500">${new Date(transaction.createdAt).toLocaleDateString()}</div>
                                </div>
                            </div>
                        `;
                        transactionHistory.appendChild(transactionDiv);
                    });
                }

                document.getElementById('batch-details').classList.remove('hidden');

            } catch (error) {
                console.error('Error loading batch details:', error);
            }
        }

        // Dropdown population functions
        async function populateFarmersDropdown() {
            try {
                const response = await fetch(`${API_BASE}/chain-actors`);
                const result = await response.json();
                const dropdown = document.getElementById('season-farmer');
                dropdown.innerHTML = '<option value="">Select Farmer</option>';
                
                if (result.success && result.data && result.data.actors) {
                    result.data.actors.forEach(actor => {
                        if (actor.actorType && actor.actorType.includes('Farmer')) {
                            const option = document.createElement('option');
                            option.value = actor.publicKey;
                            option.textContent = actor.name;
                            dropdown.appendChild(option);
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading farmers:', error);
            }
        }

        async function populateBatchesDropdown(selectId) {
            try {
                const response = await fetch(`${API_BASE}/rice-batches`);
                const result = await response.json();
                const dropdown = document.getElementById(selectId);
                
                if (!dropdown) {
                    console.error(`Dropdown element with ID '${selectId}' not found`);
                    return;
                }
                
                dropdown.innerHTML = '<option value="">Select Batch</option>';
                
                if (result.success && result.data) {
                    const batches = Array.isArray(result.data) ? result.data : (result.data.batches || []);
                    batches.forEach(batch => {
                        if (batch && batch.publicKey) {
                            const option = document.createElement('option');
                            option.value = batch.publicKey;
                            const displayText = [
                                batch.qrCode,
                                batch.batchWeightKg ? `${batch.batchWeightKg}kg` : '',
                                batch.variety || ''
                            ].filter(Boolean).join(' - ');
                            option.textContent = displayText || `Batch ${batch.publicKey.slice(0, 8)}`;
                            dropdown.appendChild(option);
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading batches:', error);
                addActivity(`❌ Failed to load batches: ${error.message}`);
            }
        }

        async function populateSeasonsDropdown() {
            try {
                const response = await fetch(`${API_BASE}/production-seasons`);
                const result = await response.json();
                const dropdown = document.getElementById('batch-season-id');
                dropdown.innerHTML = '<option value="">Select Season</option>';
                
                if (result.success && result.data && result.data.seasons) {
                    result.data.seasons.forEach(season => {
                        const option = document.createElement('option');
                        option.value = season.publicKey;
                        option.textContent = season.seasonName || `${season.cropYear} Season`;
                        dropdown.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading seasons:', error);
            }
        }

        async function populateActorsDropdown(dropdownId) {
            try {
                const response = await fetch(`${API_BASE}/chain-actors`);
                const result = await response.json();
                const dropdown = document.getElementById(dropdownId);
                dropdown.innerHTML = '<option value="">Select Actor</option>';
                
                if (result.success && result.data && result.data.actors) {
                    result.data.actors.forEach(actor => {
                        const option = document.createElement('option');
                        option.value = actor.publicKey;
                        option.textContent = `${actor.name} (${actor.actorType.join(', ')})`;
                        dropdown.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading actors:', error);
            }
        }

        // Add batch tracker initialization to main DOMContentLoaded
        function initializeBatchTracker() {
            loadBatchTracker();
            // Add event listener for batch selector
            document.getElementById('batch-selector').addEventListener('change', function() {
                displayBatchDetails(this.value);
            });
        }
    </script>
</body>
</html>
